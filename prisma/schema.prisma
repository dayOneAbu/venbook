// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  SUPER_ADMIN
  HOTEL_ADMIN
  SALES
  OPERATIONS
  FINANCE
  CUSTOMER
}

enum CustomerType {
  INDIVIDUAL
  COMPANY
}

enum BookingSource {
  STAFF
  CUSTOMER_PORTAL
}

enum BookingStatus {
  INQUIRY
  TENTATIVE
  CONFIRMED
  EXECUTED
  COMPLETED
  CANCELLED
  CONFLICT // Scenario: Exceptional overlap or race condition
  WAITLIST // Scenario 9: Resource contention fallback
}

enum TaxStrategy {
  STANDARD // VAT on Subtotal
  COMPOUND // VAT on (Subtotal + Service Charge)
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  TELEBIRR
  MPESA
  OTHER
}

model Model {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Hotel {
  id          String  @id @default(cuid())
  name        String  @db.VarChar(256)
  address     String  @default("")
  description String?
  email       String?
  phone       String?
  website     String?
  subdomain   String  @unique
  logoUrl     String?

  // Compliance and SaaS features
  isVerified    Boolean @default(false)
  tinNumber     String?
  licenseNumber String?
  city          String?
  state         String?
  country       String  @default("Ethiopia")
  location      String?

  // Settings (Scenario 2 & 4)
  taxStrategy           TaxStrategy @default(STANDARD)
  serviceChargeRate     Decimal     @default(10)
  vatRate               Decimal     @default(15)
  currency              String      @default("ETB")
  allowCapacityOverride Boolean     @default(false)

  // Safety and Lifecycle
  isDeactivated Boolean   @default(false)
  deactivatedAt DateTime?

  // Relationships
  ownerId String? @unique
  owner   User?   @relation("HotelOwner", fields: [ownerId], references: [id])

  staff     User[]     @relation("HotelStaff")
  venues    Venue[]
  customers Customer[]
  bookings  Booking[]
  resources Resource[] // Scenario 9
  invites   Invite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hotel")
}

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  phone         String?
  role          UserRole @default(CUSTOMER)

  // Onboarding
  isOnboarded Boolean @default(false)

  // Hotel ownership (1:1)
  ownedHotel Hotel? @relation("HotelOwner")

  // Staff relationship (Many:1)
  hotelId String?
  hotel   Hotel?  @relation("HotelStaff", fields: [hotelId], references: [id], onDelete: Cascade)

  // Work
  createdBookings  Booking[] @relation("BookingCreator")
  assignedBookings Booking[] @relation("BookingOwner") // Scenario 10
  receivedPayments Payment[] @relation("PaymentReceiver")

  notifications Notification[] @relation("UserNotification")

  sessions Session[]
  accounts Account[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user")
}

model Invite {
  id        String   @id @default(cuid())
  email     String
  role      UserRole @default(SALES)
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("invite")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserNotification", fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification")
}

model Customer {
  id      String @id @default(cuid())
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  companyName String
  contactName String?
  email       String?
  phone       String?
  tinNumber   String?
  type        CustomerType @default(INDIVIDUAL)

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customer")
}

model Venue {
  id          String  @id @default(cuid())
  name        String
  description String?
  hotelId     String
  hotel       Hotel   @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Specific capacities for event types
  capacityBanquet   Int?
  capacityTheater   Int?
  capacityUshape    Int?
  capacityReception Int?

  basePrice     Decimal? @db.Decimal(10, 2)
  priceUnit     String   @default("day") // "hour", "day"
  squareFootage Int?
  slug          String   @unique
  isActive      Boolean  @default(true)

  images    VenueImage[]
  amenities VenueAmenity[]
  bookings  Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("venue")
}

model Amenity {
  id     String         @id @default(cuid())
  name   String         @unique
  venues VenueAmenity[]

  @@map("amenity")
}

model VenueAmenity {
  venueId   String
  amenityId String
  venue     Venue   @relation(fields: [venueId], references: [id], onDelete: Cascade)
  amenity   Amenity @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([venueId, amenityId])
  @@map("venue_amenity")
}

model VenueImage {
  id      String @id @default(cuid())
  url     String
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)
  order   Int    @default(0)

  @@map("venue_image")
}

// Replaced BookingRequest with full Booking model
model Booking {
  id            String @id @default(cuid())
  bookingNumber String @unique // BK-2026-0001

  hotelId    String
  hotel      Hotel    @relation(fields: [hotelId], references: [id])
  venueId    String
  venue      Venue    @relation(fields: [venueId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Grouping (Scenario 6: Recurring Events)
  bookingGroupId String?

  // Operational (Scenario 10)
  conflictId   String?
  assignedToId String?
  assignedTo   User?   @relation("BookingOwner", fields: [assignedToId], references: [id])
  createdById  String
  createdBy    User    @relation("BookingCreator", fields: [createdById], references: [id])

  // Event Details
  eventName  String
  eventType  String?
  eventDate  DateTime // Keep for indexing/sorting
  startTime  DateTime // Scenario 3: Full range
  endTime    DateTime // Scenario 3: Full range
  guestCount Int

  // Snapshot Pricing (Scenario 7)
  basePrice     Decimal
  serviceCharge Decimal
  vat           Decimal
  totalAmount   Decimal
  currency      String  @default("ETB")

  status BookingStatus @default(INQUIRY)
  notes  String?

  // Operational PAX (Scenario 4)
  guaranteedPax Int  @default(0)
  actualPax     Int?

  // Layout Capture (Simplified)
  layoutType String?

  // Tax Compliance Snapshots (Scenario 7/ERCA)
  vatRateSnapshot           Decimal     @default(15)
  serviceChargeRateSnapshot Decimal     @default(10)
  taxStrategySnapshot       TaxStrategy @default(STANDARD)

  // Customer Portal (Addendum)
  isPublicBooking     Boolean       @default(false)
  customerAccessToken String?       @unique
  source              BookingSource @default(STAFF)
  specialRequests     String?
  dietaryRequests     String?

  payments  Payment[]
  resources BookingResource[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("booking")
}

model Payment {
  id        String  @id @default(cuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  amount Decimal
  method PaymentMethod

  // Split Receipts (Scenario 8)
  payerName    String?
  payerCompany String?

  // Refunds (Scenario 5)
  isRefund Boolean @default(false)

  reference String?
  notes     String?

  receivedById String?
  receivedBy   User?   @relation("PaymentReceiver", fields: [receivedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment")
}

model Resource {
  id       String @id @default(cuid())
  hotelId  String
  hotel    Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  name     String
  quantity Int    @default(1)

  bookings BookingResource[]

  @@map("resource")
}

model BookingResource {
  bookingId  String
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  quantity   Int      @default(1)

  @@id([bookingId, resourceId])
  @@map("booking_resource")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
